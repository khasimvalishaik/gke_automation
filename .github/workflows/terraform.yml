name: 'Terraform'

on:
  push:
    branches: [ "dev" ]
  pull_request:

permissions:
      contents: 'read'
      id-token: 'write'

jobs:
        terraform:
          name: 'Terraform'
          runs-on: ubuntu-latest
          environment: dev
          defaults:
            run:
              shell: bash
          permissions:
                contents: 'read'
                id-token: 'write'
          steps:
# Checkout the repository to the GitHub Actions runner
          - name: Checkout
            uses: actions/checkout@v4

          - id: auth
            name: authenticate to google cloud

            uses: google-github-actions/auth@v2
            with:
             token_format: access_token
             workload_identity_provider: projects/80021650195/locations/global/workloadIdentityPools/dev007/providers/dev007
             service_account: githubactions@stunning-base-409811.iam.gserviceaccount.com
             

          - name: Setup Terraform
            uses: hashicorp/setup-terraform@v2
            with:
             cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

          - name: Terraform Init
            run: terraform init

          - name: Terraform Format
            run: terraform fmt -check

          - name: Terraform Plan
            run: terraform plan -input=false

          - name: Terraform Apply
            if: github.ref == 'refs/heads/"dev"' && github.event_name == 'push'
            run: terraform apply -auto-approve -input=false